# üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç Fiscal Monitor

## –°–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
```bash
./start-all.sh
```

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç:
- ‚úÖ Backend API (–ø–æ—Ä—Ç 3001)
- ‚úÖ Telegram Bot
- ‚úÖ Background Worker (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
```bash
./stop-all.sh
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
```bash
./restart-all.sh
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
./status.sh
```

---

## üìã –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≥–æ—Ç–æ–≤–∞

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
psql $DATABASE_URL -c "SELECT 1"

# –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å
npm run db:init
```

### 2. Telegram –±–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω

1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –∏ –Ω–∞–π–¥–∏—Ç–µ **@BotFather**
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ: `/newbot`
3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –∏ **—Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω**
4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ: `/setprivacy` ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞ ‚Üí `Disable`

### 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ .env —Ñ–∞–π–ª

```bash
cd backend
nano .env

# –û–±–Ω–æ–≤–∏—Ç–µ —ç—Ç–∏ —Å—Ç—Ä–æ–∫–∏:
TELEGRAM_BOT_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω_–æ—Ç_BotFather
TELEGRAM_BOT_USERNAME=–≤–∞—à_username_–±–æ—Ç–∞
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Backend API
```bash
curl http://localhost:3001/health
# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç: {"status":"ok","timestamp":"..."}
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram –±–æ—Ç–∞
1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ: `/start`
3. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º

### 3. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
```bash
pm2 logs                    # –í—Å–µ –ª–æ–≥–∏
pm2 logs fiscal-api         # –¢–æ–ª—å–∫–æ API
pm2 logs telegram-bot       # –¢–æ–ª—å–∫–æ –±–æ—Ç
pm2 logs notification-worker # –¢–æ–ª—å–∫–æ worker
```

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
```bash
pm2 monit  # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
./status.sh # –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
```

---

## üéØ –ü–æ–ª–Ω—ã–π —Ñ–ª–æ—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. –ê–¥–º–∏–Ω –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É
```bash
curl -X POST http://localhost:3001/api/v1/admin/telegram/activate \
  -H "X-Admin-Key: YOUR_ADMIN_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "registration_id": 1,
    "duration_months": 1
  }'
```

### 2. –ö–ª–∏–µ–Ω—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
```bash
curl -X POST http://localhost:3001/api/v1/portal/telegram/generate-code \
  -H "X-Token: CLIENT_TOKEN"
```

–û—Ç–≤–µ—Ç:
```json
{
  "success": true,
  "code": "123456",
  "expires_in_seconds": 600,
  "bot_username": "YourFiscalBot",
  "instructions": "..."
}
```

### 3. –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç Telegram
–í Telegram –±–æ—Ç–µ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ:
```
/connect 123456
```

---

## üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PM2

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
```bash
pm2 list              # –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
pm2 restart all       # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë
pm2 stop all          # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë
pm2 delete all        # –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
pm2 save              # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
pm2 logs              # –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏
pm2 flush             # –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
```

### –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å–∏—Å—Ç–µ–º—ã
```bash
pm2 startup           # –°–æ–∑–¥–∞—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
pm2 save              # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
```

---

## üêõ Troubleshooting

### Backend –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
pm2 logs fiscal-api --lines 50

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç
lsof -i :3001

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ .env
cat backend/.env
```

### Telegram –±–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
pm2 logs telegram-bot --lines 50

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω
grep TELEGRAM_BOT_TOKEN backend/.env

# –¢–µ—Å—Ç —Ç–æ–∫–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é
curl "https://api.telegram.org/bot<YOUR_TOKEN>/getMe"
```

### Worker –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
pm2 logs notification-worker --lines 50

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—á–µ—Ä–µ–¥—å –≤ –ë–î
psql $DATABASE_URL -c "SELECT COUNT(*) FROM notification_queue;"
```

---

## üìä –ü–æ–ª–µ–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏
```sql
SELECT * FROM notification_subscriptions;
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Telegram
```sql
SELECT * FROM telegram_connections WHERE is_active = true;
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—á–µ—Ä–µ–¥—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```sql
SELECT * FROM notification_queue WHERE processed = false;
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
```sql
SELECT * FROM notification_history ORDER BY sent_at DESC LIMIT 10;
```

---

## üéâ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ `./start-all.sh` –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ñ–æ–Ω–µ —á–µ—Ä–µ–∑ PM2.

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `./status.sh` –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã.

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `/docs`
- –õ–æ–≥–∏: `pm2 logs`
- –°—Ç–∞—Ç—É—Å: `./status.sh`
